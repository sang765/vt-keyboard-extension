name: Build and Test Extension

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        browser: [chromium, firefox]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install web-ext
        run: npm install -g web-ext

      - name: Install crx3 for Chromium
        if: matrix.browser == 'chromium'
        run: npm install -g crx3

      - name: Lint for Firefox
        if: matrix.browser == 'firefox'
        run: web-ext lint

      - name: Build extension
        run: web-ext build --overwrite-dest

      - name: Prepare Firefox artifact
        if: matrix.browser == 'firefox'
        run: mv web-ext-artifacts/*.zip web-ext-artifacts/vt-keyboard-extension.xpi

      - name: Generate private key for Chromium
        if: matrix.browser == 'chromium'
        run: openssl genrsa -out key.pem 2048

      - name: Build CRX for Chromium
        if: matrix.browser == 'chromium'
        run: |
          mkdir -p build-artifacts
          crx3 --pack-extension=. --key=key.pem --output=build-artifacts/vt-keyboard-extension.crx

      - name: Upload Firefox artifact
        if: matrix.browser == 'firefox'
        uses: actions/upload-artifact@v4
        with:
          name: vt-keyboard-extension-firefox
          path: web-ext-artifacts/vt-keyboard-extension.xpi

      - name: Upload Chromium artifact
        if: matrix.browser == 'chromium'
        uses: actions/upload-artifact@v4
        with:
          name: vt-keyboard-extension-chromium
          path: build-artifacts/vt-keyboard-extension.crx